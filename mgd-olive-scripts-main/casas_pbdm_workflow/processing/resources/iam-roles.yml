Resources:
    stepfunctionrole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: ${self:provider.stage}-pbdm-StepFunctionRole
            AssumeRolePolicyDocument:
                Version: '2012-10-17' 
                Statement:
                    -   Effect: Allow
                        Principal:
                            Service:
                                - lambda.amazonaws.com
                                - states.amazonaws.com
                        Action: sts:AssumeRole
            ManagedPolicyArns:
                -   arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
            Policies:
                -   PolicyName: ${self:provider.stage}-pbdm-StepFunctionPolicy
                    PolicyDocument:
                        Version: '2012-10-17'
                        Statement:
                            -   Effect: Allow
                                Action:
                                    - "ecs:RunTask"
                                Resource: !Sub "arn:aws:ecs:${self:provider.region}:#{AWS::AccountId}:cluster/${self:provider.stage}-pbdm-wf-cluster"        
                            -   Effect: Allow
                                Action:
                                    - "ecs:RunTask"
                                Resource: !Sub "arn:aws:ecs:${self:provider.region}:#{AWS::AccountId}:task-definition/${self:provider.stage}-pbdm-task-definition:*"
                            -   Effect: Allow
                                Action:
                                    - events:PutTargets
                                    - events:PutRule
                                    - events:DescribeRule
                                Resource: !Sub "arn:aws:events:${self:provider.region}:#{AWS::AccountId}:rule/StepFunctionsGetEventsForECSTaskRule"
                            -   Effect: Allow
                                Action:
                                    - iam:PassRole
                                Resource: !Sub "arn:aws:iam::#{AWS::AccountId}:role/${self:provider.stage}-pbdm-ecsTaskExecutionRole"
    ecsTaskExecutionRole:
        Type: AWS::IAM::Role
        Properties:
            RoleName: "${self:provider.stage}-pbdm-ecsTaskExecutionRole"
            AssumeRolePolicyDocument:
                Version: '2012-10-17'
                Statement:
                    -   Effect: Allow
                        Principal:
                            Service:
                                - lambda.amazonaws.com
                                - ecs-tasks.amazonaws.com
                                - ec2.amazonaws.com
                        Action: sts:AssumeRole
            ManagedPolicyArns:
                -   arn:aws:iam::aws:policy/service-role/AmazonECSTaskExecutionRolePolicy
            Policies:
                -   PolicyName: ${self:provider.stage}-pbdm-ecsTaskExecutionPolicy
                    PolicyDocument:
                        Version: '2012-10-17'
                        Statement:
                            -   Effect: Allow
                                Action:
                                    - "s3:PutObject"
                                    - "s3:ListBucket"
                                    - "s3:PutObjectAcl"
                                    - "s3:GetObject"
                                Resource:
                                    - "arn:aws:s3:::${self:custom.BUCKET_NAME}"
                                    - "arn:aws:s3:::${self:custom.SECOND_BUCKET_NAME}"
                                    - "arn:aws:s3:::*/*"
                            -   Effect: Allow
                                Action:
                                    - "logs:CreateLogGroup"
                                    - "logs:CreateLogStream"
                                    - "logs:PutLogEvents"
                                Resource: "*"
